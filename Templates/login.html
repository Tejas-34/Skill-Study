{% load static %}

<!DOCTYPE html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Login - Skill-Study</title>
    <meta name="description" content="Skill-Study" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="shortcut icon" href="../favicon.png" type="image/x-icon" />
    <!-- Place favicon.png.ico in the root directory -->

    <!-- CSS here -->
     
    <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap.min.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/animate.min.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/magnific-popup.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/fontawesome-all.min.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/flaticon-skillgro.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/flaticon-skillgro-new.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/swiper-bundle.min.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/default-icons.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/select2.min.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/odometer.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/aos.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/plyr.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/spacing.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/tg-cursor.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/main.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/custom.css' %}" />
  </head>

  <body>
    <!--Preloader-->
    <div id="custom-preloader">
        <div class="custom-loader-wrapper">
          <div class="custom-loader-circe">
            <div class="custom-loader-icon">
              <h1 class="custom-loader-text">.</h1>
            </div>
          </div>
        </div>
      </div>
      <!--Preloader-end -->

    <!-- Scroll-top -->
    <button class="scroll__top scroll-to-target" data-target="html">
      <i class="tg-flaticon-arrowhead-up"></i>
    </button>
    <!-- Scroll-top-end-->

    <!-- header-area -->
    {% include "nav.html" %}
    <!-- header-area-end -->

    <!-- main-area -->
    <main class="main-area fix">
      <!-- breadcrumb-area -->
      <section
        class="breadcrumb__area breadcrumb__bg"
        data-background="{% static 'images/background/breadcrumb_bg.jpg' %}"
      >
        <div class="container">
          <div class="row">
            <div class="col-12">
              <div class="breadcrumb__content">
                <h3 class="title">Login Account</h3>
                <nav class="breadcrumb">
                  <span property="itemListElement" typeof="ListItem">
                    <a href="index.html">Home</a>
                  </span>
                  <span class="breadcrumb-separator"
                    >
                    <img src="{% static 'images/icons/right-arrow-svgrepo-com.svg' %}" alt=">" />
                </span>
                  <span property="itemListElement" typeof="ListItem"
                    >Login</span
                  >
                </nav>
              </div>
            </div>
          </div>
        </div>
      </section>
      <!-- breadcrumb-area-end -->

      <!-- singUp-area -->
      <section class="singUp-area section-py-120">
        <div class="container">
          <div class="row justify-content-center">
            <div class="col-xl-6 col-lg-8">
              <div class="singUp-wrap">
                <h2 class="title">Welcome to Skill-Study! ðŸš€</h2>
                <p>
                  Ready to dive back in? Enter your email and password below to
                  continue your learning journey. Letâ€™s get started!
                </p>

                <form
                  action="{% url 'login' %}"
                  method="post"
                  class="account__form"
                >
                {% csrf_token %}
                  <input
                    type="hidden"
                    name="csrf_token"
                    value="be9c59f81803ef64a17a574bf5817beb"
                  />

                  <div class="form-grp">
                    <label for="email">Email</label>
                    <input
                      name="email"
                      type="email"
                      placeholder="Enter your email"
                      required
                    />
                  </div>
                  <div class="form-grp">
                    <label for="password">Password</label>
                    <div
                      class="password-input-wrapper"
                      style="position: relative"
                    >
                      <input
                        name="password"
                        type="password"
                        placeholder="Enter your password"
                        required
                      />
                      <button
                        type="button"
                        class="password-toggle"
                        style="
                          position: absolute;
                          right: 10px;
                          top: 50%;
                          transform: translateY(-50%);
                          border: none;
                          background: none;
                          cursor: pointer;
                        "
                      >
                      
                      <img src="{% static 'images/icons/eye-slash.svg' %}" alt="X" style="display: none;">
                      </button>
                    </div>
                  </div>
                  <div class="account__check">
                    <div class="account__check-remember">
                      <input
                        type="checkbox"
                        class="form-check-input"
                        value=""
                        id="terms-check"
                      />
                      <label for="terms-check" class="form-check-label"
                        >Remember Me</label
                      >
                    </div>
                    <div class="account__check-forgot">
                      <a href="forgot-password.html"
                        >Forgot Password?</a
                      >
                    </div>
                  </div>
                  <button type="submit" class="btn btn-two arrow-btn">
                    Sign In<img
                      src="{% static 'images/icons/right-arrow-svgrepo-com.svg' %}"
                      alt="img"
                      class="injectable"
                    />
                  </button>
                </form>
                <div class="account__switch">
                  <p>
                    New to Skill-Study?<a href="/register/0"
                      >Create an Account</a
                    >
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <!-- singUp-area-end -->
    </main>
    <!-- main-area-end -->

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const toggleButton = document.querySelector(".password-toggle");
        const passwordInput = toggleButton.previousElementSibling;
        const eyeIcon = toggleButton.querySelector("i");

        toggleButton.addEventListener("click", function () {
          const type =
            passwordInput.getAttribute("type") === "password"
              ? "text"
              : "password";
          passwordInput.setAttribute("type", type);
          eyeIcon.classList.toggle("fa-eye");
          eyeIcon.classList.toggle("fa-eye-slash");
        });
      });
    </script>
    <style>
      .designed-by {
        text-align: right;
      }
    </style>

    <!-- footer-area -->
    {% include "footer.html" %}
    <!-- footer-area-end -->

    <!-- JS here -->
    <script src="assets/js/jquery-3.6.0.min.js"></script>
    <script src="/assets/js/bootstrap.min.js"></script>
    <script src="/assets/js/imagesloaded.pkgd.min.js"></script>
    <script src="/assets/js/jquery.magnific-popup.min.js"></script>
    <script src="/assets/js/jquery.odometer.min.js"></script>
    <script src="/assets/js/jquery.appear.js"></script>
    <script src="/assets/js/tween-max.min.js"></script>
    <script src="/assets/js/select2.min.js"></script>
    <script src="/assets/js/swiper-bundle.min.js"></script>
    <script src="/assets/js/jquery.marquee.min.js"></script>
    <script src="/assets/js/tg-cursor.min.js"></script>
    <script src="/assets/js/vivus.min.js"></script>
    <script src="/assets/js/ajax-form.js"></script>
    <script src="/assets/js/svg-inject.min.js"></script>
    <script src="/assets/js/jquery.circleType.js"></script>
    <script src="/assets/js/jquery.lettering.min.js"></script>
    <script src="/assets/js/plyr.min.js"></script>
    <script src="/assets/js/wow.min.js"></script>
    <script src="/assets/js/aos.js"></script>
    <script src="assets/js/main.js"></script>

    <script src="https://cdn.rawgit.com/HubSpot/odometer/master/odometer.min.js"></script>

    <script>
      SVGInject(document.querySelectorAll("img.injectable"));
    </script>
  </body>
</html>


<script>
  // Function to handle login form submission
  function handleLogin(event) {
    event.preventDefault(); // Prevent default form submission

    // Get email and password values from the form
    const email = document.querySelector('input[name="email"]').value;
    const password = document.querySelector('input[name="password"]').value;

    // Make a POST request to the login API endpoint
    fetch('/login/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value, // Include CSRF token
      },
      body: JSON.stringify({ email, password }), // Send email and password in JSON format
    })
      .then((response) => {
        if (!response.ok) {
          // If response status is not OK (e.g., 400 or 401), throw an error
          return response.json().then((data) => {
            throw data;
          });
        }

        if(response.status === 403){
          throw new Error('You have not paid for the course');
        }
        return response.json(); // Parse the JSON response
      })
      .then((data) => {
        console.log('Success:', data); // Log success response

        // Save the JWT token in session storage
        sessionStorage.setItem('jwtToken', data.access);
        sessionStorage.setItem('refreshToken', data.refresh);
        sessionStorage.setItem('email', data.email);

        const pkg = data.pkg; // Retrieve the package information from the response
        console.log(pkg)

        // Show success message using SweetAlert2
        if (data.paid) {
          Swal.fire({
            icon: 'success',
            title: 'Login Successful!',
            text: 'You have successfully logged in.',
            timer: 2000, // Auto-close after 2 seconds
            showConfirmButton: false,
          }).then(() => {
            window.location.href = '/dashboard'; // Redirect to dashboard
          });
        } else {
          Swal.fire({
            icon: 'warning',
            title: 'Pay Your Money!',
            text: 'Pay to unlock your account.',
            timer: 2000, // Auto-close after 4 seconds
            showConfirmButton: false,
          }).then(() => {
            if (pkg) {
              window.location.href = `/payment/${pkg}`; // Redirect to payment page with package ID
            } else {
              console.error('Package ID is missing!');
              Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: 'Unable to proceed to payment. Please contact support.',
              });
            }
          });
        }
      })
      .catch((error) => {
        console.error('Error:', error);

        if(error.message){
          Swal.fire({
            icon: 'info',
            title: 'Under Verification!',
            text: error.message || 'Invalid email or password. Please try again.',
          });
        }
        else{
        // Show error message using SweetAlert2
        Swal.fire({
          icon: 'error',
          title: 'Oops!',
          text: error.error || 'Invalid email or password. Please try again.',
        });}
      });
  }

  // Attach the function to the form submission event
  document.querySelector('.account__form').addEventListener('submit', handleLogin);
</script>
